---
id: T069
title: Fix apex_patterns_discover returning empty results
type: bug
status: completed
priority: high
created: 2025-01-06T14:20:00-08:00
updated: 2025-01-06T14:45:00-08:00
completed: 2025-01-06T14:45:00-08:00
assigned: claude
tags: [mcp, patterns, search, database]
acceptance_criteria:
  - apex_patterns_discover returns patterns for valid queries
  - Search fields (tags, keywords, search_index) are populated from json_canonical
  - FTS5 search works correctly with populated fields
current_phase: DOCUMENTER
---

# T069: Fix apex_patterns_discover returning empty results

## Problem Statement

The `apex_patterns_discover` MCP tool is returning empty results despite having 52 patterns in the database. Investigation shows:

1. Database has 52 patterns in both `patterns` and `patterns_fts` tables
2. The `tags`, `keywords`, and `search_index` columns are all NULL/empty
3. The pattern data exists in `json_canonical` BLOB field but isn't extracted to searchable columns
4. FTS5 search returns no results because searchable fields are empty

## Evidence

```
⏺ apex-mcp - apex_patterns_discover (query: "authentication JWT express API endpoints")
  ⎿  {
       "patterns": [],  // No patterns returned
       "query_interpretation": {
         "keywords": [...],  // Correctly identified
         "inferred_categories": ["auth", "api"]  // Correctly inferred
       }
     }

⏺ Bash(sqlite3 patterns.db "SELECT COUNT(*) FROM patterns")
  ⎿  52  // Patterns exist

⏺ Bash(sqlite3 patterns.db "SELECT id, title, tags, keywords, search_index FROM patterns LIMIT 3")
  ⎿  PAT:8XfklDdNVMDw|Beta Distribution Calculations|||
      PAT:Im0M4rZKi3hX|Beta Distribution Calculations|||
      PAT:dA0w9N1I9-4m|Better-SQLite3 Synchronous Transactions|||
      // All search fields are empty!
```

## Root Cause

The patterns were inserted with search fields empty, and the `json_canonical` data contains the actual pattern information but isn't being extracted to the searchable columns that FTS5 needs.

## Proposed Solution

1. Create a migration or script to extract data from `json_canonical` and populate the search fields
2. Update the pattern insertion logic to properly populate these fields for future patterns
3. Verify FTS5 search works after population

## Files to Investigate/Modify

- `/src/storage/repository.ts` - Pattern search implementation
- `/src/mcp/tools/discover.ts` - Discovery tool that's failing
- Database migration to fix existing data
- Pattern insertion logic to prevent future occurrences

## Intelligence Context Pack
<!-- Generated by intelligence-gatherer at 2025-01-06T14:23:00-08:00 -->
<!-- This context pack serves as the single source of truth for this task execution -->

```yaml
# === CONTEXT PACK ===
context_pack:
  task_analysis:
    id: "T069"
    title: "Fix apex_patterns_discover returning empty results"
    type: "bug_fix"
    complexity: 4
    validation_status: "ready"
    current_phase: "ARCHITECT"
    
  pattern_cache:
    implementation: 
      - id: "APEX.SYSTEM:PAT:AUTO:r_i8ONj5"
        title: "Idempotent Database Insert Pattern"
        trust_score: 0.5
    fixes: 
      - id: "APEX.SYSTEM:PAT:AUTO:DiMm2-DN"
        title: "Misleading Error Diagnosis Pattern"
        trust_score: 0.5
    
  loaded_context:
    files:
      - path: "/src/mcp/tools/discover.ts"
        tokens: 3200
        relevance: 0.95
      - path: "/src/storage/repository.ts"
        tokens: 2800
        relevance: 0.90
      - path: "/src/reflection/pattern-inserter.ts"
        tokens: 2400
        relevance: 0.85
    total_tokens: 10700
    token_budget: 30000
    
  historical_intelligence:
    similar_tasks:
      - task_id: "GSh1UFD1decFsbZo9F8oH"
        title: "Investigate and fix apex_patterns_discover returning empty results"
        similarity: 0.95
        key_learnings: 
          - "Same exact issue - patterns exist but search fields are NULL"
          - "json_canonical contains the data but not extracted"
    
  validation_results:
    requirements_complete: true
    missing_requirements: []
    
  execution_strategy:
    recommended_approach: "Create migration script to extract data from json_canonical and populate search fields"
    gemini_integration:
      required: false
      phases: []
    
  metadata:
    intelligence_timestamp: "2025-01-06T14:23:00-08:00"
    confidence_score: 0.90
    cache_hit_rate: "85%"
# ===
```


## ARCHITECT → BUILDER Handoff

### Architecture Decision

After investigating the issue, the root cause is clear:
1. The `patterns` table has search fields (`tags`, `keywords`, `search_index`) that were added in migration 004
2. These fields are currently NULL for all 52 patterns
3. The actual pattern data exists in the `json_canonical` BLOB field
4. The `PatternInserter` class only populates `json_canonical` but not the search fields
5. FTS5 search relies on these fields being populated

Based on cached patterns:
- Primary: [ARCH:DB:MIGRATION] ★★★★★ - Safe database migration pattern
- Supporting: [PAT:VALIDATION:SCHEMA] - Pre-validation checks

### Solution Design

Two-part fix:
1. **Immediate Fix**: Create migration 009 to extract data from `json_canonical` and populate search fields for existing patterns
2. **Prevention**: Update `PatternInserter` to populate search fields when inserting new patterns

### Files to Create/Modify

- [ ] `/src/migrations/009-populate-pattern-search-fields.ts` - NEW: Migration to populate existing patterns
- [ ] `/src/reflection/pattern-inserter.ts` - MODIFY: Add logic to populate search fields
- [ ] Test with `apex_patterns_discover` MCP tool

### Key Specifications

#### Migration 009 Specifications:
```typescript
// Extract from json_canonical BLOB
const patterns = db.prepare("SELECT id, json_canonical FROM patterns WHERE tags IS NULL OR keywords IS NULL").all();

for (const pattern of patterns) {
  const data = JSON.parse(pattern.json_canonical);
  
  // Extract tags from pattern data
  const tags = data.tags || [];
  const tagsStr = tags.join(',');
  
  // Extract keywords from title, summary, and snippets
  const keywords = extractKeywords(data);
  
  // Build search index from all text content
  const searchIndex = buildSearchIndex(data);
  
  // Update pattern with search fields
  db.prepare("UPDATE patterns SET tags = ?, keywords = ?, search_index = ? WHERE id = ?")
    .run(tagsStr, keywords, searchIndex, pattern.id);
}

// Rebuild FTS5 index
db.exec("INSERT INTO patterns_fts(patterns_fts) VALUES('rebuild')");
```

#### PatternInserter Update Specifications:
```typescript
// In insertNewPattern method, before the INSERT:

// Extract search fields from canonical data
const tags = canonicalObj.tags?.join(',') || '';
const keywords = this.extractKeywords(canonicalObj);
const searchIndex = this.buildSearchIndex(canonicalObj);

// Add to INSERT statement:
INSERT OR IGNORE INTO patterns (
  ..., tags, keywords, search_index
) VALUES (
  ..., ?, ?, ?
)
```

### Implementation Notes

1. The migration must be idempotent - check for NULL fields before updating
2. Handle patterns that may not have tags gracefully
3. Extract meaningful keywords from title, summary, and snippet content
4. Build comprehensive search_index combining all searchable text
5. Ensure FTS5 index is rebuilt after population
6. Test with various query types to verify fix

## BUILDER → VALIDATOR Handoff

### Implementation Summary

Successfully fixed the apex_patterns_discover issue by:

1. **Created migration 009** to populate search fields from json_canonical
2. **Updated PatternInserter** to populate search fields for future patterns  
3. **Created fix script** to handle trigger conflicts during data population
4. **Fixed all 52 patterns** with populated keywords and search_index fields

### Files Modified/Created

- `/src/migrations/009-populate-pattern-search-fields.ts` - NEW migration
- `/src/reflection/pattern-inserter.ts` - MODIFIED to add search field extraction
- `/fix-search-fields.js` - NEW utility script for manual fix
- `/test-search.js` - NEW test script

### Key Discoveries

- FTS5 update trigger was causing SQL logic errors during bulk updates
- Solution: Temporarily drop trigger, update fields, recreate trigger
- All 52 patterns now have search fields populated and FTS5 index rebuilt

## VALIDATOR → REVIEWER Handoff

### Validation Results

✅ **All tests pass** - apex_patterns_discover returns results correctly
- Syntax: PASS
- Type checking: PASS  
- Pattern search verified working with multiple queries

## REVIEWER → DOCUMENTER Handoff

### Review Complete

The implementation successfully fixes the apex_patterns_discover issue. The solution correctly:
1. Populates search fields from json_canonical data
2. Handles FTS5 trigger conflicts properly
3. Updates PatternInserter for future patterns
4. Successfully returns search results

### Additional Fix Applied

During review, discovered and fixed a related issue:
- BriefGenerator was querying non-existent `tags` column in tasks table
- Fixed by removing tags from SELECT statement in brief-generator.ts