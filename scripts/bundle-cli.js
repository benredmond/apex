#!/usr/bin/env node

/**
 * Bundle APEX CLI entry point for pkg compatibility
 * Transforms ES modules to CommonJS and handles import.meta.url
 */

import { build } from 'esbuild';
import fs from 'fs-extra';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '..');

async function bundleCli() {
  console.log('🔨 Bundling APEX CLI for pkg compatibility...');

  try {
    // Ensure dist directory exists
    const distDir = path.join(rootDir, 'dist', 'cli');
    if (!fs.existsSync(path.join(distDir, 'apex.js'))) {
      throw new Error('dist/cli/apex.js not found. Run "npm run build" first.');
    }

    // Output directly to dist directory for pkg compatibility
    const bundleDir = path.join(rootDir, 'dist');

    // Configure esbuild for CommonJS output with pkg compatibility
    await build({
      entryPoints: [path.join(rootDir, 'dist', 'cli', 'apex.js')],
      bundle: true,
      platform: 'node',
      target: 'node18',
      format: 'cjs',
      outfile: path.join(bundleDir, 'apex-bundled.cjs'),
      external: [
        // Keep native dependencies external - pkg handles these via assets
        'better-sqlite3',
        'fsevents',
        // Keep Node.js built-ins external
        'fs', 'path', 'os', 'crypto', 'util', 'events', 'stream', 
        'child_process', 'readline', 'url', 'querystring', 'http', 'https'
      ],
      define: {
        // Transform import.meta.url to a placeholder that we'll handle via banner
        'import.meta.url': '__APEX_FILE_URL__'
      },
      banner: {
        js: `// APEX CLI Bundle - Generated by esbuild for pkg compatibility
const __APEX_FILE_URL__ = require('url').pathToFileURL(__filename).toString();
`
      },
      logLevel: 'info',
      minify: false, // Keep readable for debugging
      sourcemap: false, // Not needed for binary distribution
    });

    // Verify bundled file
    const bundledFile = path.join(bundleDir, 'apex-bundled.cjs');
    const stats = await fs.stat(bundledFile);
    console.log(`✅ Bundle created successfully: ${bundledFile}`);
    console.log(`📦 Bundle size: ${Math.round(stats.size / 1024)} KB`);

    // Quick validation - try to require the bundle
    console.log('🧪 Validating bundle...');
    try {
      const bundledModule = require(bundledFile);
      console.log('✅ Bundle validation passed - CommonJS module loads correctly');
    } catch (error) {
      console.warn('⚠️ Bundle validation warning:', error.message);
      console.warn('This might still work with pkg, but check for runtime issues');
    }

  } catch (error) {
    console.error('❌ Failed to bundle CLI:', error.message);
    if (error.errors) {
      error.errors.forEach(err => console.error('  -', err.text));
    }
    process.exit(1);
  }
}

if (import.meta.url === `file://${__filename}`) {
  bundleCli().catch(console.error);
}

export { bundleCli };